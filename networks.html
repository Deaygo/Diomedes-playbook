<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html> 
<head> 
  <title>Diomedes - Networks</title> 
  <link rel="stylesheet" type="text/css" media="screen" href="css/view.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="css/forms.css" />
</head> 
<body class="prefWindow popUpWindow" onLoad="load( )"> 
  <h1>Networks</h1>
  <div id="networksList" onclick="handleListClick( event );"></div>
  <a href="#" onclick="showAddForm( event );">Add a Network</a>
  <form class="hidden" id="form" onsubmit="saveNetworks( event );">
    <input type="hidden" id="id" value="0"/>
    <div class="formItem">
      <label for="name">Name: </label> <input type="text" id="name" />
    </div>
    <div class="formItem">
      <label for="nick">Nick: </label> <input type="text" id="nick" />
    </div>
    <div class="formItem">
      <label for="altNick">Alternative nick: </label> <input type="text" id="altNick" />
    </div>
    <div class="formItem">
      <label for="userName">Username: </label> <input type="text" id="userName" />
    </div>
    <div class="formItem">
      <label for="realName">Real Name: </label> <input type="text" id="realName" />
    </div>
    <div class="formItem">
      <label for="finger">Finger: </label> <input type="text" id="finger" />
    </div>
    <div class="formItem">
      <label for="active">Active: </label> <input type="checkbox" id="active"  checked="true"/>
    </div>
    <div class="formItem">
      <label for="autoJoin">Auto join: </label> <input type="checkbox" id="autoJoin" checked="true" />
    </div>
    <input type="submit" value="Save" />
    <button onclick="closeForm( event );">Cancel</button>
  </form>
  <button onclick="closeWindow( event );">Close Window</button>
  <script type="text/javascript">

    var bridge = window.opener.networksBridge;
    var util = bridge.util;
		var dojo = bridge.dojo;
    var topics = bridge.topics;
    var prefs = bridge.preferences;
    var networks = bridge.networks;

    function load ( ) {
      displayNetworks ( networks );
    }

    function displayNetworks ( networks ) {
      var n = get( "networksList" );
      n.innerHTML = "";
      var r = [];
      for ( var i = 0; i < networks.length; i++ ) {
        r.push( getNetworkHTML( networks[ i ] ) ); 
      }
      n.innerHTML = r.join( "" );
    }

    function getNetworkHTML( network ) {
      return [
        '<div><span class="networkName">', network.name, '</span> ',
        '<a href="#" id="edit.', network.id, '">Edit</a> ',
        '<a href="#" id="delete.', network.id, '">Delete</a> ',
        '</div>'].join( "" );
    }

    function clearForm ( ) {
      get( "name" ).value = "";
      get( "id" ).value = "0";
      for ( pref in prefs ) {
        var n = get( pref );
        if ( n ) {
          n.value = prefs[ pref ];
        }
      }
    }

    function saveNetworks ( event ) {
      dojo.stopEvent( event );
      util.log( "Saving Networks." );
      var networkData = {};
      //get prefs
      var id = parseInt( get( "id" ).value, 10 );
      if ( !this.getItem( "name", "Network name", networkData ) ) return;
      if ( !this.getItem( "nick", "Nick", networkData ) ) return;
      if ( !this.getItem( "altNick", "Alternate nick", networkData ) ) return;
      if ( !this.getItem( "userName", "Username", networkData ) ) return;
      if ( !this.getItem( "realName", "Real name", networkData ) ) return;
      if ( !this.getItem( "finger", "Finger", networkData ) ) return;
      if ( !this.getItem( "active", "Active", networkData, true ) ) return;
      if ( !this.getItem( "autoJoin", "Auto join", networkData, true ) ) return;
      if ( id === 0 ) {
        dojo.publish( topics.NETWORK_ADD, [ networkData ] );
        closeWindow( event );
        return;
      } else {
        networkData.id = id;
        updateNetworks( networkData );
        dojo.publish( topics.NETWORK_EDIT, [ id, networkData ] );
      }
      closeForm( event );
    }

    function updateNetworks ( network ) {
      for ( var i = 0; i < networks.length; i++ ) {
        var temp = networks[ i ];
        if ( temp.id == network.id ) {
          networks[ i ] = network;
          displayNetworks( networks );
          return;
        }
      }
    }

    function closeForm ( event ) {
      dojo.stopEvent( event );
      dojo.remClass( get( "form" ), "hidden" );
    }

    function showForm ( ) {
      dojo.remClass( get( "form" ), "hidden" );
    }

    function getItem( id, name, o, isCheckbox ) {
      if ( isCheckbox ) {
        var value = get( id ).checked;
        if ( value === true || value === false ) {
          o[ id ] = value;
          return true;
        }
      }
      var value =  get( id ).value;
      value = dojo.trim( value );
      if ( !value ) {
        alert( name + " required." );
        return false;
      }
      o[ id ] = value;
      return true;
    }

    function get ( name ) {
      return util.get( name, document );
    }

    function handleListClick ( event ) {
      var id = event.target.id;
      if ( id ) {
        var parts = id.split( "." );
        if ( parts.length ) {
          var cmd = parts[ 0 ];
          var id = parts [ 1 ];
          if ( cmd == "edit" ) {
            showEditForm( id );
          } else if ( cmd == "delete" ) {
            deleteNetwork( id );
          }
        }
      }
    }

    function deleteNetwork ( id ) {
      dojo.publish( topics.NETWORK_DELETE, [ id ] );
      var newNetworks = [];
      for ( var i = 0; i < networks.length; i++ ) {
        var network = networks[ i ];
        if ( network.id != id ) {
          newNetworks.push( network );
        }
      }
      networks = newNetworks;
      displayNetworks( networks );
    }

    function showEditForm ( id ) {
      var network = null;
      for ( var i = 0; i < networks.length; i++ ) {
        if ( networks[ i ].id == id ) {
          network = networks[ i ];
          break;
        }
      }
      if ( !network ) return;
      var keys = [ "id", "name", "nick", "altNick", "userName", "realName", "finger" ];
      for ( var i = 0; i < keys.length; i++ ) {
        var key = keys[ i ];
        get( key ).value = network[ key ];
      }
      get( "active" ).checked = network[ "active" ];
      get( "autoJoin" ).checked = network[ "autoJoin" ];
      showForm( );
    }

    function showAddForm ( event ) {
      dojo.stopEvent( event );
      clearForm( );
      showForm( );
    }

    function closeWindow ( event ) {
      dojo.stopEvent( event );
      window.close( );
    }

  </script>
</body>
</html>




